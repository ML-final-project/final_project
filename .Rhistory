longitude,
contains("normal")) %>%
na_if(-9999) %>%
na.omit() %>%
mutate(date = ymd(date)) %>%
st_as_sf(coords = c("longitude", "latitude"),
crs = 4326, remove = FALSE) %>%
st_transform("+proj=utm +zone=42N +datum=WGS84 +units=km")
View(merged_lag)
noaa <- read_csv(make_path(config$data_path$noaa,
"Chicago2010Daily.csv")) %>%
set_names(to_snake_case(colnames(.))) %>%
select(station_name,
date,
elevation,
latitude,
longitude,
contains("normal")) %>%
na_if(-9999) %>%
na.omit() %>%
mutate(date = ymd(date)) %>%
st_as_sf(coords = c("longitude", "latitude"),
crs = 4326, remove = FALSE) %>%
st_transform("+proj=utm +zone=42N +datum=WGS84 +units=km")
pm25 <- read_csv(make_path(config$data_path$pm25,
"pm25_chicago_2010.csv")) %>%
set_names(to_snake_case(colnames(.))) %>%
mutate(date = mdy(date)) %>%
st_as_sf(coords = c("site_longitude", "site_latitude"),
crs = 4326, remove = FALSE) %>%
st_transform("+proj=utm +zone=42N +datum=WGS84 +units=km") %>%
na.omit() %>%
select(date, site_name, daily_mean_pm_2_5_concentration)
merge_plotting %>% extract(geometry, c('lat', 'lon'), '\\((.*), (.*)\\)', convert = TRUE)
merge_plotting %>%
st_transform(4326)
merge_plotting %>%
st_transform(4326) %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE) %>%
st_set_geometry(NULL)
merge_plotting %>%
st_transform(4326) %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE) %>%
st_set_geometry(NULL)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name")
merge_plotting %>%
st_transform(4326) %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE) %>%
st_set_geometry(NULL)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name")
merge_plotting %>%
st_transform(4326) #%>%
merge_plotting %>%
st_transform(4326) %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE) #%>%
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
merge_plotting %>%
st_transform(4326) %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE)
source('~/final_project/analysis/source/merging_script.R', echo=TRUE)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE) %>%
##############
## aod data ##
##############
aod_047 <- read_csv(make_path(config$data_path$aod,
"2010ImputedOpticalDepth_047nm.csv"),
col_names = FALSE) %>%
rename(date = X1,
aod47 = X2)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
st_buffer(10) %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE)
View(pm25_sites)
unique(merged_lag$site_name)
library(RColorBrewer)
brewer.pal(30, "Set3")
merge_lag <- cbind(merged_aod, lag_prcp, lag_snow) %>%
mutate(color = brewer.pal(30, "Set1"))
brewer.pal(30, 'qual')
distinctColorPalette(n)
install.packages("randomcoloR")
library(randomcoloR)
n <- 30
palette <- distinctColorPalette(n)
merge_lag <- cbind(merged_aod, lag_prcp, lag_snow) %>%
mutate(color = distinctColorPalette(30))
merge_lag <- cbind(merged_aod, lag_prcp, lag_snow) %>%
group_by(site_name) %>%
mutate(color = distinctColorPalette(30))
merge_lag <- cbind(merged_aod, lag_prcp, lag_snow) %>%
group_by(site_name)
lag_prcp <- data.frame(lagmatrix(merged_aod$mtd_prcp_normal, 1)) %>%
select(X2) %>%
rename(mtd_prcp_normal_lag1 = X2)
lag_snow <- data.frame(lagmatrix(merged_aod$mtd_snow_normal, 1)) %>%
select(X2) %>%
rename(mtd_snow_normal_lag1 = X2)
merged_aod <- left_join(aod_047, aod_055, by = "date") %>%
right_join(., merged, by = "date")
merge_lag <- cbind(merged_aod, lag_prcp, lag_snow) %>%
group_by(site_name)
View(merged_lag)
View(merge_lag)
ggplot(merge_lag) %>%
geom_point(aes(x = longitude,
y = latitude))
ggplot(merge_lag) +
geom_point(aes(x = longitude,
y = latitude))
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
extract(geometry,
c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)',
convert = TRUE)
View(merge_plotting)
ggplot(merge_plotting) +
geom_point(aes(x = longitude,
y = latitude))
View(merge_plotting)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
extract(geometry,
c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)',
convert = TRUE) %>%
st_set_geometry(NULL)
noaa_plotting <- noaa %>%
select(station_name, longitude, latitude) %>%
st_set_geometry(NULL) %>%
distinct()
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") #%>%
View(merge_plotting)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") #%>%
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) #%>%
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
extract(geometry,
c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)',
convert = TRUE)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
extract(geometry,
c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)',
convert = FALSE)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
extract(geometry,
c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)',
convert = TRUE)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326)
merge_plotting %>%
extract(geometry,
c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)',
convert = TRUE)
ggplot(merge_plotting) +
geom_point(aes(x = longitude,
y = latitude)) %>%
select(-geometry)
ggplot(merge_plotting) +
geom_point(aes(x = longitude,
y = latitude)) %>%
st_set_geometry(NULL)
df <- ggplot(merge_plotting) +
geom_point(aes(x = longitude,
y = latitude))
df <- ggplot(merge_plotting) +
geom_point(aes(x = longitude,
y = latitude))
View(df)
df <- select(UID, Site.ID, lat, lon) %>% as_data_frame()
df <- merge_plotting %>%
extract(geometry,
c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)',
convert = TRUE)
View(df)
colnames(df)
df <- select(date,
site_name,
daily_mean_pm_2_5_concentration,
geometry,
lat_pm25,
lon_pm25,
station_name,
longitude) %>% as_data_frame()
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
mutate(Geom = gsub('[()°]', '', geometry)) %>%
separate(col = Geom, into = c('Latitude', 'Longitude '), sep = '\\,')
config$data_path$noaa
make_path(config$data_path$noaa,
"Chicago2010Daily.csv")
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
mutate(Geom = gsub('[()°]', '', geometry)) #%>%
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) #%>%
ggplot(merge_plotting) +
geom_sf
library(sf)
ggplot(merge_plotting) +
geom_sf()
ggplot(merge_plotting) +
geom_sf() +
geom_point(aes(x = longitude, y = latitude))
ggplot(merge_plotting) +
geom_sf() +
geom_point(aes(x = longitude, y = latitude), color = "red")
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
distinct(site_name, station_name)
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
distinct(site_name, station_name, longitude, latitude)
df <- unlist(st_geometry(merge_plotting)) %>%
matrix(ncol=2,byrow=TRUE) %>%
as_tibble() %>%
setNames(c("lon","lat"))
df <- merge_plotting %>% extract(geometry, c('lat', 'lon'), '\\((.*), (.*)\\)', convert = TRUE)
View(df)
df <- merge_plotting %>% extract(geometry, c('lat', 'lon'), '\\((.*), (.*)\\)', convert = TRUE) %>%
st_set_geometry(NULL)
df %>%
st_set_geometry(NULL)
df %>%
st_set_geometry(NULL)
ggplot(merge_plotting) +
geom_point(aes(x = longitude, y = latitude), color = "red")
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
distinct(site_name, station_name, longitude, latitude) %>%
lat_long_df <- merge_plotting %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE)
lat_long_df <- merge_plotting %>%
extract(geometry, c('lat_pm25', 'lon_pm25'), '\\((.*), (.*)\\)', convert = TRUE)
View(lat_long_df)
ggplot(lat_long_df) +
geom_sf() +
geom_point(aes(x = longitude, y = latitude), color = "red")
ggplot(lat_long_df) +
geom_point(aes(x = longitude, y = latitude), color = "red")
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
distinct(site_name, station_name, longitude, latitude)
ggplot(merge_plotting) +
geom_sf() +
geom_point(aes(x = longitude, y = latitude), color = "red")
setwd("~/final_project/")
noaa <- read_csv(make_path(config$data_path$noaa,
"2066581.csv"))
View(noaa)
noaa <- read_csv(make_path(config$data_path$noaa,
"2066581.csv")) %>%
filter(NAME == "DENVER 2.0 SSE, CO US")
View(noaa)
noaa <- read_csv(make_path(config$data_path$noaa,
"2066581.csv")) %>%
filter(NAME == "DENVER 2.0 SSE, CO US") %>%
set_names(to_snake_case(colnames(.))) %>%
select(station_name,
date,
elevation,
latitude,
longitude,
contains("normal"))
View(noaa)
noaa <- read_csv(make_path(config$data_path$noaa,
"Chicago2010Daily.csv")) %>%
set_names(to_snake_case(colnames(.))) %>%
select(station_name,
date,
elevation,
latitude,
longitude,
contains("normal")) %>%
na_if(-9999) %>%
na.omit() %>%
mutate(date = ymd(date)) %>%
st_as_sf(coords = c("longitude", "latitude"),
crs = 4326, remove = FALSE) %>%
st_transform("+proj=utm +zone=42N +datum=WGS84 +units=km")
View(noaa)
noaa <- read_csv(make_path(config$data_path$noaa,
"Chicago2010Daily.csv")) %>%
set_names(to_snake_case(colnames(.))) %>%
select(station_name,
date,
elevation,
latitude,
longitude,
contains("normal")) %>%
na_if(-9999) %>%
na.omit() %>%
mutate(date = ymd(date)) %>%
st_as_sf(coords = c("longitude", "latitude"),
crs = 4326, remove = FALSE) %>%
st_transform("+proj=utm +zone=42N +datum=WGS84 +units=km")
View(noaa)
temp <- read_csv(make_path(config$data_path$noaa,
"2066581.csv"))
View(temp)
View(noaa)
rm(list = ls())
library(yaml)
library(rprojroot)
library(tidyverse)
library(lubridate)
library(snakecase)
library(sf)
library(plm)
setwd("~/final_project/")
make_path <- is_git_root$make_fix_file()
config <- yaml.load_file(make_path("analysis/config.yml"))
out_path <- make_path(config$build_path)
data_out <- make_path(config$data_path$merge)
source(str_c(config$group_code, "prelim.R"))
noaa <- read_csv(make_path(config$data_path$noaa,
"Chicago2010Daily.csv")) %>%
set_names(to_snake_case(colnames(.))) %>%
select(station_name,
date,
elevation,
latitude,
longitude,
contains("normal")) %>%
na_if(-9999) %>%
na.omit() %>%
mutate(date = ymd(date)) %>%
st_as_sf(coords = c("longitude", "latitude"),
crs = 4326, remove = FALSE) %>%
st_transform("+proj=utm +zone=42N +datum=WGS84 +units=km")
pm25 <- read_csv(make_path(config$data_path$pm25,
"pm25_chicago_2010.csv")) %>%
set_names(to_snake_case(colnames(.))) %>%
mutate(date = mdy(date)) %>%
st_as_sf(coords = c("site_longitude", "site_latitude"),
crs = 4326, remove = FALSE) %>%
st_transform("+proj=utm +zone=42N +datum=WGS84 +units=km") %>%
na.omit() %>%
select(date, site_name, daily_mean_pm_2_5_concentration)
pm25_sites <- distinct(pm25, site_name)
noaa_sites <- distinct(noaa, station_name)
min.col <- function(m, ...) max.col(-m, ...)
pm25_sites$row_num <- st_distance(pm25_sites, noaa_sites) %>% min.col(.)
sites <- noaa_sites %>%
mutate(row_num = row_number()) %>%
st_set_geometry(NULL) %>%
right_join(., pm25_sites, by = "row_num") %>%
select(-c(row_num, geometry))
merged <- pm25 %>%
left_join(., sites, by = "site_name") %>%
st_set_geometry(NULL) %>%
left_join(., noaa, by = c("station_name","date")) %>%
select(-geometry)
write.csv(merged, str_c(data_out, "/merged_noaa_pm25.csv"))
noaa_plotting <- noaa %>%
select(station_name, longitude, latitude) %>%
st_set_geometry(NULL) %>%
distinct()
merge_plotting <- pm25 %>%
left_join(., sites, by = "site_name") %>%
left_join(., noaa_plotting, by = "station_name") %>%
st_transform(4326) %>%
distinct(site_name, station_name, longitude, latitude)
ggplot(merge_plotting) +
geom_sf() +
geom_point(aes(x = longitude, y = latitude), color = "red")
aod_047 <- read_csv(make_path(config$data_path$aod,
"2010ImputedOpticalDepth_047nm.csv"),
col_names = FALSE) %>%
rename(date = X1,
aod47 = X2)
aod_055 <- read_csv(make_path(config$data_path$aod,
"2010ImputedOpticalDepth_055nm.csv"),
col_names = FALSE) %>%
rename(date = X1,
aod55 = X2)
merged_aod <- left_join(aod_047, aod_055, by = "date") %>%
right_join(., merged, by = "date")
write.csv(merged_aod, str_c(data_out, "/merged_noaa_pm25_aod.csv"))
lagmatrix <- function(x,max.lag) embed(c(rep(NA,max.lag), x), max.lag+1)
lag_prcp <- data.frame(lagmatrix(merged_aod$mtd_prcp_normal, 1)) %>%
select(X2) %>%
rename(mtd_prcp_normal_lag1 = X2)
lag_snow <- data.frame(lagmatrix(merged_aod$mtd_snow_normal, 1)) %>%
select(X2) %>%
rename(mtd_snow_normal_lag1 = X2)
merge_lag <- cbind(merged_aod, lag_prcp, lag_snow) %>%
group_by(site_name)
reg_vars <- merge_lag %>%
select(elevation, contains("normal"), aod47, aod55) %>%
names() %>%
paste(collapse = " + ")
View(lag_snow)
View(merge_lag)
reg_vars <- merge_lag %>%
select(elevation, contains("normal"), aod47, aod55) %>%
names() #%>%
reg_vars <- merge_lag %>%
select(elevation, contains("normal"), aod47, aod55) #%>%
View(reg_vars)
reg_vars <- merge_lag %>%
ungroup()
select(elevation, contains("normal"), aod47, aod55) %>%
names() %>%
paste(collapse = " + ")
reg_vars <- merge_lag %>%
ungroup() %>%
select(elevation, contains("normal"), aod47, aod55) %>%
names() %>%
paste(collapse = " + ")
summary(plm(as.formula(paste0("daily_mean_pm_2_5_concentration ~ ", reg_vars)),
data = merge_lag,
index = c("date"),
model = "pooling",
effect = "twoways"))
merge_lag <- cbind(merged_aod, lag_prcp, lag_snow)
View(merge_lag)
reg_vars <- merge_lag %>%
select(elevation, contains("normal"), aod47, aod55) %>%
names() %>%
paste(collapse = " + ")
summary(plm(as.formula(paste0("daily_mean_pm_2_5_concentration ~ ", reg_vars)),
data = merge_lag,
index = c("date"),
model = "pooling",
effect = "twoways"))
week_season <- read_csv(make_path(config$data_path$noaa,
"merged_plus_weekday_season.csv"))
week_season <- read_csv(make_path(config$data_path$merge,
"merged_plus_weekday_season.csv"))
View(week_season)
pm25 <- read_csv(make_path(config$data_path$pm25,
"pm25_chicago_2010.csv")) %>%
set_names(to_snake_case(colnames(.))) %>%
mutate(date = mdy(date)) %>%
st_as_sf(coords = c("site_longitude", "site_latitude"),
crs = 4326, remove = FALSE) %>%
st_transform("+proj=utm +zone=42N +datum=WGS84 +units=km") %>%
na.omit() %>%
select(date, site_name, daily_mean_pm_2_5_concentration)
pm25 <- read_csv(make_path(config$data_path$pm25,
"pm25_chicago_2010.csv")) %>%
set_names(to_snake_case(colnames(.))) %>%
mutate(date = mdy(date)) %>%
st_as_sf(coords = c("site_longitude", "site_latitude"),
crs = 4326, remove = FALSE) %>%
st_transform("+proj=utm +zone=42N +datum=WGS84 +units=km") #%>%
View(pm25)
